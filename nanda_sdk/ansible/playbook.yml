---
- name: Setup Internet of Agents (Non-Root)
  hosts: servers
  become: no
  vars:
    home_dir: "{{ ansible_env.HOME }}"
    app_dir: "{{ home_dir }}/internet_of_agents"
    venv_path: "{{ app_dir }}/venv"
    cert_dir: "{{ home_dir }}/.local/ssl"

  tasks:
    - name: Check if required Python packages are available
      command: python3 -c "import venv, subprocess, ssl"
      register: python_check
      failed_when: false

    - name: Display Python dependency info
      debug:
        msg: |
          ⚠️  If this fails, you may need to install: python3-venv
          Run: sudo apt install python3-venv (requires sudo once)
      when: python_check.rc != 0

    - name: Ensure user has git installed
      command: which git
      register: git_check
      failed_when: false

    - name: Display git dependency info
      debug:
        msg: |
          ⚠️  Git is required but not found. 
          Run: sudo apt install git (requires sudo once)
      when: git_check.rc != 0

    - name: Create user directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      with_items:
        - "{{ app_dir }}"
        - "{{ cert_dir }}"
        - "{{ home_dir }}/.local/bin"
        - "{{ home_dir }}/.config/systemd/user"

    - name: Clone internet_of_agents repository
      git:
        repo: "{{ github_repo }}"
        dest: "{{ app_dir }}"
        version: nonroot_users
        force: yes
        clone: yes
        update: yes
        accept_hostkey: yes

    - name: Create Python virtual environment
      command: python3 -m venv "{{ venv_path }}"
      args:
        creates: "{{ venv_path }}"

    - name: Install Python requirements in virtual environment
      pip:
        requirements: "{{ app_dir }}/requirements.txt"
        state: present
        virtualenv: "{{ venv_path }}"

    - name: Install certbot in virtual environment
      pip:
        name: certbot
        state: present
        virtualenv: "{{ venv_path }}"

    - name: Create certificates directory
      file:
        path: "{{ cert_dir }}"
        state: directory
        mode: '0755'

    - name: Generate Let's Encrypt certificates using standalone mode
      shell: |
        {{ venv_path }}/bin/certbot certonly \
          --standalone \
          --non-interactive \
          --agree-tos \
          --email admin@{{ domain_name }} \
          --domains {{ domain_name }} \
          --http-01-port 8080 \
          --config-dir {{ cert_dir }}/config \
          --work-dir {{ cert_dir }}/work \
          --logs-dir {{ cert_dir }}/logs
      register: certbot_result
      failed_when: certbot_result.rc != 0 and 'already exists' not in certbot_result.stderr

    - name: Set certificate paths for Let's Encrypt
      set_fact:
        cert_path: "{{ cert_dir }}/config/live/{{ domain_name }}/fullchain.pem"
        key_path: "{{ cert_dir }}/config/live/{{ domain_name }}/privkey.pem"

    - name: Update .bashrc with environment variables
      lineinfile:
        path: "{{ home_dir }}/.bashrc"
        line: "{{ item }}"
        state: present
        create: yes
      with_items:
        - 'export ANTHROPIC_API_KEY="{{ anthropic_api_key }}"'
        - 'export SMITHERY_API_KEY="{{ smithery_api_key }}"'
        - 'export VIRTUAL_ENV="{{ venv_path }}"'
        - 'export PATH="${VIRTUAL_ENV}/bin:$PATH"'

    - name: Make start_running_agents.sh executable
      file:
        path: "{{ app_dir }}/agents/start_running_agents.sh"
        mode: '0755'

    - name: Update startup script to use user paths
      replace:
        path: "{{ app_dir }}/agents/start_running_agents.sh"
        regexp: '/opt/internet_of_agents'
        replace: "{{ app_dir }}"

    - name: Update startup script environment file path
      replace:
        path: "{{ app_dir }}/agents/start_running_agents.sh"
        regexp: '/etc/internet_of_agents.env'
        replace: "{{ home_dir }}/.config/internet_of_agents.env"

    - name: Create user environment file
      copy:
        dest: "{{ home_dir }}/.config/internet_of_agents.env"
        content: |
          ANTHROPIC_API_KEY={{ anthropic_api_key }}
          VIRTUAL_ENV={{ venv_path }}
          AGENT_ID_PREFIX={{ agent_id_prefix }}
          DOMAIN_NAME={{ domain_name }}
          SMITHERY_API_KEY={{ smithery_api_key }}
          REGISTRY_URL={{ registry_url }}
          CERT_PATH={{ cert_path }}
          KEY_PATH={{ key_path }}
          {% if num_agents is defined %}
          NUM_AGENTS={{ num_agents }}
          {% endif %}
        mode: '0644'

    - name: Create user systemd service
      template:
        src: templates/internet_of_agents_user.service.j2
        dest: "{{ home_dir }}/.config/systemd/user/internet_of_agents.service"
        mode: '0644'

    - name: Reload user systemd daemon
      systemd:
        daemon_reload: yes
        scope: user

    - name: Enable and start user service
      systemd:
        name: internet_of_agents
        state: started
        enabled: yes
        scope: user
        daemon_reload: yes

    - name: Create startup script for convenience
      copy:
        dest: "{{ home_dir }}/.local/bin/start-nanda-agents"
        content: |
          #!/bin/bash
          source {{ home_dir }}/.config/internet_of_agents.env
          cd {{ app_dir }}/agents
          {{ app_dir }}/agents/start_running_agents.sh
        mode: '0755'

    - name: Display agent information
      debug:
        msg: |
          ===================================================
          🎉 Your agent is now ready! 
          
          📍 Running with Let's Encrypt SSL certificates:
          - Domain: https://{{ domain_name }}
          - Certificate: {{ cert_path }}
          
          🌐 Access your agent{% if num_agents is defined and num_agents > 1 %}s{% endif %} at:
          {% if num_agents is defined and num_agents > 1 %}
          {% for i in range(num_agents) %}
             Agent {{ i + 1 }}: https://chat.nanda-registry.com/landing.html?agentId=agents{{ agent_id_prefix }}{{ i }}
          {% endfor %}
          {% else %}
          https://chat.nanda-registry.com/landing.html?agentId=agents{{ agent_id_prefix }}0
          {% endif %}
          
          🔧 Management commands:
          - Start: systemctl --user start internet_of_agents
          - Stop: systemctl --user stop internet_of_agents  
          - Status: systemctl --user status internet_of_agents
          - Logs: journalctl --user -u internet_of_agents -f
          
          📁 Files located in: {{ app_dir }}
          🔐 Let's Encrypt certs in: {{ cert_dir }}/config/live/{{ domain_name }}/
          ===================================================
      no_log: false 
